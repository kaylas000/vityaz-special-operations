import { Test, TestingModule } from '@nestjs/testing';\nimport { CombatService } from '../services/combat.service';\n\ndescribe('CombatService', () => {\n  let service: CombatService;\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [CombatService],\n    }).compile();\n\n    service = module.get<CombatService>(CombatService);\n  });\n\n  describe('Damage Calculation', () => {\n    it('should calculate base damage correctly', () => {\n      const damage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 10,\n        bodyPart: 'chest',\n      });\n      expect(damage).toBeGreaterThan(0);\n      expect(damage).toBeLessThanOrEqual(25);\n    });\n\n    it('should apply distance modifier', () => {\n      const closeDamage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 5,\n        bodyPart: 'chest',\n      });\n\n      const farDamage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 50,\n        bodyPart: 'chest',\n      });\n\n      expect(closeDamage).toBeGreaterThan(farDamage);\n    });\n\n    it('should apply headshot multiplier (2x)', () => {\n      const bodyDamage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 10,\n        bodyPart: 'chest',\n      });\n\n      const headDamage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 10,\n        bodyPart: 'head',\n      });\n\n      expect(headDamage).toBeCloseTo(bodyDamage * 2, 0);\n    });\n\n    it('should apply leg damage reduction (0.75x)', () => {\n      const bodyDamage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 10,\n        bodyPart: 'chest',\n      });\n\n      const legDamage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 10,\n        bodyPart: 'leg',\n      });\n\n      expect(legDamage).toBeLessThan(bodyDamage);\n    });\n\n    it('should apply armor reduction', () => {\n      const noDamage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 10,\n        bodyPart: 'chest',\n        armor: 0,\n      });\n\n      const withArmor = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 10,\n        bodyPart: 'chest',\n        armor: 100,\n      });\n\n      expect(withArmor).toBeLessThan(noDamage);\n    });\n\n    it('should not exceed 100% damage reduction', () => {\n      const damage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 10,\n        bodyPart: 'chest',\n        armor: 999,\n      });\n\n      expect(damage).toBeGreaterThanOrEqual(0);\n      expect(damage).toBeLessThanOrEqual(25);\n    });\n\n    it('should handle critical strike (1.5x)', () => {\n      const normalDamage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 10,\n        bodyPart: 'chest',\n      });\n\n      const criticalDamage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 10,\n        bodyPart: 'chest',\n        isCritical: true,\n      });\n\n      expect(criticalDamage).toBeCloseTo(normalDamage * 1.5, 0);\n    });\n\n    it('should apply weapon multiplier', () => {\n      const rifleDamage = service.calculateDamage({\n        weaponDamage: 25,\n        distance: 10,\n        bodyPart: 'chest',\n        weaponType: 'rifle',\n      });\n\n      const pistolDamage = service.calculateDamage({\n        weaponDamage: 15,\n        distance: 10,\n        bodyPart: 'chest',\n        weaponType: 'pistol',\n      });\n\n      expect(rifleDamage).toBeGreaterThan(pistolDamage);\n    });\n  });\n\n  describe('Hit Registration', () => {\n    it('should calculate hit probability based on distance', () => {\n      const closeHit = service.calculateHitProbability({\n        distance: 5,\n      });\n\n      const farHit = service.calculateHitProbability({\n        distance: 50,\n      });\n\n      expect(closeHit).toBeGreaterThan(farHit);\n    });\n\n    it('should apply accuracy modifier', () => {\n      const baseHit = service.calculateHitProbability({\n        distance: 20,\n        accuracy: 1.0,\n      });\n\n      const lowAccuracy = service.calculateHitProbability({\n        distance: 20,\n        accuracy: 0.75,\n      });\n\n      expect(baseHit).toBeGreaterThan(lowAccuracy);\n    });\n\n    it('should never exceed 100% hit chance', () => {\n      const probability = service.calculateHitProbability({\n        distance: 1,\n        accuracy: 10,\n      });\n\n      expect(probability).toBeLessThanOrEqual(1.0);\n      expect(probability).toBeGreaterThanOrEqual(0);\n    });\n\n    it('should never go below 0% hit chance', () => {\n      const probability = service.calculateHitProbability({\n        distance: 200,\n        accuracy: 0,\n      });\n\n      expect(probability).toBeGreaterThanOrEqual(0);\n      expect(probability).toBeLessThanOrEqual(1.0);\n    });\n  });\n\n  describe('Team Operations', () => {\n    it('should calculate team damage correctly', () => {\n      const teamDamage = service.calculateTeamDamage([\n        { playerId: '1', damage: 100 },\n        { playerId: '2', damage: 150 },\n        { playerId: '3', damage: 75 },\n      ]);\n\n      expect(teamDamage).toBe(325);\n    });\n\n    it('should calculate team accuracy', () => {\n      const teamAccuracy = service.calculateTeamAccuracy([\n        { playerId: '1', accuracy: 0.8 },\n        { playerId: '2', accuracy: 0.9 },\n        { playerId: '3', accuracy: 0.7 },\n      ]);\n\n      expect(teamAccuracy).toBeCloseTo(0.8, 1);\n    });\n\n    it('should detect friendly fire', () => {\n      const isFriendlyFire = service.isFriendlyFire({\n        shooterTeam: 'red',\n        targetTeam: 'red',\n      });\n\n      expect(isFriendlyFire).toBe(true);\n    });\n\n    it('should not flag enemy fire as friendly fire', () => {\n      const isFriendlyFire = service.isFriendlyFire({\n        shooterTeam: 'red',\n        targetTeam: 'blue',\n      });\n\n      expect(isFriendlyFire).toBe(false);\n    });\n  });\n\n  describe('Balance Validation', () => {\n    it('should validate weapon balance', () => {\n      const weapons = [\n        { name: 'rifle', damage: 25, rof: 600 },\n        { name: 'pistol', damage: 15, rof: 900 },\n        { name: 'shotgun', damage: 60, rof: 60 },\n      ];\n\n      const isBalanced = service.validateWeaponBalance(weapons);\n      expect(isBalanced).toBe(true);\n    });\n\n    it('should detect overpowered weapons', () => {\n      const weapons = [\n        { name: 'rifle', damage: 100, rof: 900 }, // OP\n        { name: 'pistol', damage: 15, rof: 900 },\n      ];\n\n      const isBalanced = service.validateWeaponBalance(weapons);\n      expect(isBalanced).toBe(false);\n    });\n  });\n\n  describe('Anti-Cheat', () => {\n    it('should detect impossible accuracy', () => {\n      const stats = {\n        shotsCount: 100,\n        hitsCount: 100,\n        distance: 100,\n      };\n\n      const isCheat = service.detectAimbot(stats);\n      expect(isCheat).toBe(true);\n    });\n\n    it('should allow reasonable accuracy', () => {\n      const stats = {\n        shotsCount: 100,\n        hitsCount: 75,\n        distance: 20,\n      };\n\n      const isCheat = service.detectAimbot(stats);\n      expect(isCheat).toBe(false);\n    });\n\n    it('should detect suspicious kill patterns', () => {\n      const kills = [\n        { timestamp: 0, headshot: true },\n        { timestamp: 100, headshot: true },\n        { timestamp: 200, headshot: true },\n        { timestamp: 300, headshot: true },\n      ];\n\n      const isSuspicious = service.detectKillPattern(kills);\n      expect(isSuspicious).toBe(true);\n    });\n\n    it('should detect speed hacking', () => {\n      const movement = {\n        distance: 1000,\n        time: 100, // 10 units/ms = impossible speed\n      };\n\n      const isSpeedhack = service.detectSpeedhack(movement);\n      expect(isSpeedhack).toBe(true);\n    });\n  });\n});\n